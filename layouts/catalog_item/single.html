{{ define "main" }}
<main class="view pb posr bg-light">
  <img class="bg-light__img posa pointer db" src="/img/view-bg.svg" alt="" />
  <div class="container index">
    {{ partial "breadcrumbs.html" . }}

    <div class="card-list df jcsb">
      <div class="card-left">
        <div class="card-top df aic">
          <div class="card-star dif aic">
            <img src="/img/star.svg" alt="" class="img">
            <span>{{ .Params.rating }}</span>
          </div>
          <div class="card-top__item card-top__item-votes df aic">Total Votes: <span>{{ .Params.total_votes }}</span>
          </div>
          <div class="card-top__item df aic"><img src="/img/radio.svg" alt="">{{ T "catalog_created" }}: <span>{{ .Params.created
              }}</span></div>
        </div>
        <h1 class="card-title">{{ .Title }}</h1>
        <a href="{{ .Params.website_url }}" target="_blank"
          class="card-link hide link link-only-mob">{{ .Params.website_url }}</a>
        <img src="{{ .Params.logo }}" alt="{{ .Title }}" title="{{ .Title }}"
          class="img card-right__img card-right__img-mobile">

        <div class="card-mobile hide">
          <div class="card-right__item">
            <div class="card-right__item-title">Location:</div>
            <div class="card-right__item-flex df aic">
                <img src="/catalog/flags/{{ .Params.country_code }}.png" alt="{{ .Params.country_name }}"
                  title="{{ .Params.country_name }}" class="img"/> &nbsp;

                <span class="db"> {{ .Params.country_name }} {{ if .Params.region_name }}> {{ .Params.region_name }}{{
                  end }} {{ if .Params.city_name }}> {{ .Params.city_name }}{{ end }}
                </span>
            </div>
          </div>
          <div class="card-right__item">
            <div class="card-right__item-title">Language:</div>
            <div class="card-right__item-flex df aic">
              <!-- <img src="img/lang-2.svg" alt="" class="img"> -->
              <span class="db"> {{ range .Params.languages }}
                  <span>{{ . }}</span>
                  {{ end }}
              </span>

            </div>
          </div>
          <div class="card-right__item">
            <div class="card-right__item-title">Genres:</div>
            <div class="card-right__item-list df aic fxw">
              {{ range .Params.genres }}
                <div class="card-right__item-hash dif aic">#{{ . }}</div>
              {{ end }}
            </div>
          </div>
        </div>

        <div class="card-mob-list hide">
          <div class="card-top__item df aic"><img src="/img/radio.svg" alt="">{{ T "catalog_created" }}: <span>{{ .Params.created }}</span></div>
        </div>
        
        <a href="{{ .Params.website_url }}" target="_blank"
          class="card-link db link">{{ .Params.website_url }}</a>
        <div class="card-text">{{ .Params.description }}</div>

        <div class="card-flex">
          <div class="card-player">
            <div class="player">
              <div class="player-btn"></div>
              <div class="player-select">
                <div class="select">
                  <select>
                    <option value="320kbps, mp3" selected>320kbps, mp3</option>
                    <option value="320kbps, mp3">320kbps, mp3</option>
                    <option value="320kbps, mp3">320kbps, mp3</option>
                  </select>
                </div>
              </div>
              <div class="volume-wrapper">
                <div class="volume-icon"></div>
                <div class="volume-slider">
                  <div class="volume-fill" style="width: 70%;"><span></span></div>
                </div>
              </div>
              <div class="player-time">00:00</div>
            </div>
          </div>
          <div class="card-flex__right">
            <div class="card-flex__right-title">Links:</div>
            <div class="card-flex__right-list">
              <a href="#" class="card-flex__right-link">
                <img src="/img/link-1.svg" alt="" class="img">
                <span>m3u</span>
              </a>
              <a href="#" class="card-flex__right-link">
                <img src="/img/link-1.svg" alt="" class="img">
                <span>PLS</span>
              </a>
              <a href="#" class="card-flex__right-link">
                <img src="/img/link-1.svg" alt="" class="img">
                <span>Web</span>
              </a>
            </div>
          </div>
        </div>

        <div class="card-save">
          <div class="card-soc__title"><img src="/img/radio.svg" alt=""><strong>Отправить/Сохранить радио в социальных сетях:</strong></div>
          <div class="card-save__list">
            {{ if eq .Lang "en" }}
            <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                <a class="a2a_button_email"></a>
                <a class="a2a_button_copy_link"></a>
                <a class="a2a_button_facebook"></a>
                <a class="a2a_button_telegram"></a>
                <a class="a2a_button_mastodon"></a>
                <a class="a2a_button_google_gmail"></a>
                <a class="a2a_button_snapchat"></a>
                <a class="a2a_button_twitter"></a>
                <a class="a2a_button_wechat"></a>
                <a class="a2a_button_whatsapp"></a>
                <a class="a2a_button_reddit"></a>
                <a class="a2a_button_linkedin"></a>
                <a class="a2a_button_x"></a>
                <a class="a2a_button_vk"></a>
                <a class="a2a_button_odnoklassniki"></a>
                <a class="a2a_button_viber"></a>
              </div>
            {{ end }}
            {{ if eq .Lang "ru" }}
            <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
              <a class="a2a_button_email"></a>
              <a class="a2a_button_copy_link"></a>
              <a class="a2a_button_telegram"></a>
              <a class="a2a_button_snapchat"></a>
              <a class="a2a_button_twitter"></a>
              <a class="a2a_button_wechat"></a>
              <a class="a2a_button_whatsapp"></a>
              <a class="a2a_button_reddit"></a>
              <a class="a2a_button_linkedin"></a>
              <a class="a2a_button_x"></a>
              <a class="a2a_button_vk"></a>
              <a class="a2a_button_odnoklassniki"></a>
            </div>
            {{ end }}
          </div>
        </div>

        <div class="card-soc" id="radio-voting-bar" data-server-url="{{ $.Site.BaseURL }}" data-radio-id="{{ $.Params.id }}">
          <div class="card-soc__wrapper">
            <div class="card-soc__title"><img src="/img/radio.svg" alt="">Рейтинг <span>Оцените радио от 1 до 10</span>
            </div>
            <div class="card-soc__scroll">
              <div class="card-soc__list">

                {{ range $i := seq 1 10 }}
                  <div class="card-soc__block voting-item" data-score="{{ $i }}">
                    <label class="card-soc__radio">
                      <input type="radio" name="rating">
                      <img src="/img/smile_{{ $i }}.svg" alt="" class="img">
                      <span>{{ $i }}</span>
                      <small></small>
                    </label>
                  </div>
                {{ end }}
              </div>
            </div>
          </div>
          <div id="vote-alert" class="index vote-alert" style="display: none;"></div>
          <div class="card-soc__bottom">
            <span>Итоговая оценка: <strong>{{ .Params.rating }}</strong> из 10</span>
            <small>({{ .Params.total_votes }} голоса)</small>
          </div>
        </div>

        <div class="card-left__mobile">
          <a class="card-right__btn btn" href="#form" data-modal-btn><img class="db" src="/img/marker.svg" alt=""><span
              class="db">Добавить свое радио</span></a>
        </div>


        <div class="card-box card-reviews">
          <div class="card-box__wrapper">
            
            {{ if eq .Lang "en" }}
            <!-- Facebook Comments Plugin -->
            <div class="index fb-comments" data-href="{{ .Permalink }}" data-width="100%" data-numposts="7"></div>
            {{ end }}

            {{ if eq .Lang "ru" }}
            <!-- VK comments container -->
            <div class="index comments-wrap"><div id="vk_comments"></div></div>
            {{ end }}
          </div>
        </div>
      </div>

      <div class="card-right">
        <div class="card-sticky">
          <div class="card-right__box">
            <img src="{{ .Params.logo }}" alt="{{ .Title }}" title="{{ .Title }}" class="img card-right__img">

            <div class="card-right__item">
              <div class="card-right__item-title">Location:</div>
              <div class="card-right__item-flex df aic">
                <img src="/catalog/flags/{{ .Params.country_code }}.png" alt="{{ .Params.country_name }}"
                  title="{{ .Params.country_name }}" class="img"/> &nbsp;

                <span class="db"> {{ .Params.country_name }} {{ if .Params.region_name }}> {{ .Params.region_name }}{{
                  end }} {{ if .Params.city_name }}> {{ .Params.city_name }}{{ end }}
                </span>
              </div>
            </div>
            <div class="card-right__item">
              <div class="card-right__item-title">Language:</div>
              <div class="card-right__item-flex df aic">
                <!--<img src="img/lang-2.svg" alt="" class="img">-->
                <span class="db"> {{ range .Params.languages }}
                  <span>{{ . }}</span>
                  {{ end }}
                </span>
              </div>
            </div>
            <div class="card-right__item">
              <div class="card-right__item-title">Genres:</div>
              <div class="card-right__item-list df aic fxw">
                {{ range .Params.genres }}
                <div class="card-right__item-hash dif aic">#{{ . }}</div>
                {{ end }}

              </div>
            </div>

          </div>
          <a class="card-right__btn btn" href="#form" data-modal-btn><img class="db" src="/img/marker.svg" alt=""><span
              class="db">Submit Your Radio</span></a>
        </div>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Audio Player Logic
      const playPauseButtons = document.querySelectorAll('.play-pause-btn');
      const audioElements = document.querySelectorAll('.stream-audio');
      const volumeSlider = document.getElementById('volume-slider');

      function stopAllStreams() {
        audioElements.forEach(audio => {
          audio.pause();
          audio.currentTime = 0;
        });
        playPauseButtons.forEach(btn => {
          btn.querySelector('.play-icon').style.display = 'inline';
          btn.querySelector('.pause-icon').style.display = 'none';
        });
      }

      playPauseButtons.forEach(button => {
        button.addEventListener('click', () => {
          const streamId = button.getAttribute('data-stream-id');
          const audio = document.getElementById(streamId);
          const isPlaying = !audio.paused;

          stopAllStreams();

          if (!isPlaying) {
            audio.volume = volumeSlider.value;
            audio.play().catch(e => console.error("Playback failed:", e));
            button.querySelector('.play-icon').style.display = 'none';
            button.querySelector('.pause-icon').style.display = 'inline';
          }
        });
      });

      // Existing Voting Bar Logic
      const votingBar = document.getElementById('radio-voting-bar');
      if (votingBar) {
        const votingItems = document.querySelectorAll('.voting-item');
        // const originalColors = new Map();
        let hasVoted = false;
        const serverUrl = votingBar.getAttribute('data-server-url');
        const radioId = parseInt(votingBar.getAttribute('data-radio-id'));

        function showAlert(message, type) {
          const alert = document.getElementById('vote-alert');
          alert.textContent = message;
          alert.className = `index vote-alert ${type}`;
          alert.style.display = 'block';

          setTimeout(() => {
            alert.style.display = 'none';
          }, 5000);
        }

        function disableVoting() {
          hasVoted = true;
          votingItems.forEach(item => {
            // const face = item.querySelector('.voting-face');
            item.classList.add('disabled');
          });
        }

        async function submitVote(radioId, score, serverUrl) {
          console.log("submitVote")
          if(hasVoted){
            showAlert('Already voted', 'success');
            return;
          };
          console.log("serverUrl: ", serverUrl)
          try {
            const response = await fetch(`${serverUrl}api/v1/catalog/vote`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                radio_id: radioId,
                score: score
              })
            });

            if (response.ok) {
              showAlert('Vote submitted successfully!', 'success');
              disableVoting();
            } else if (response.status === 403) {
              showAlert('You have already voted for this radio station.', 'error');
              disableVoting();
            } else {
              showAlert('Error submitting vote. Please try again.', 'error');
            }
          } catch (error) {
            showAlert('Network error. Please check your connection.', 'error');
          }
        }

        votingItems.forEach(item => {
          const score = parseInt(item.getAttribute('data-score'), 10);

          // Click event for voting
          item.addEventListener('click', () => {
            //if (!hasVoted && !face.classList.contains('disabled')) {
            submitVote(radioId, score, serverUrl);
          }, { once: true });

          // Hover effects
          /*
          item.addEventListener('mouseover', () => {
            if (hasVoted) return;

            const hoveredScore = score;
            votingItems.forEach(innerItem => {
              const innerFace = innerItem.querySelector('.voting-face');
              const innerCircle = innerFace.querySelector('.face-circle');
              const innerScore = parseInt(innerFace.getAttribute('data-score'), 10);

              if (innerScore <= hoveredScore) {
                const green = Math.round(255 * (innerScore - 1) / 9);
                const red = 255 - green;
                const highlightColor = `rgb(${red}, ${green}, 0)`;
                innerCircle.setAttribute('fill', highlightColor);
              } else {
                innerCircle.setAttribute('fill', originalColors.get(innerScore));
              }
            });
          });

          item.addEventListener('mouseout', () => {
            if (hasVoted) return;

            votingItems.forEach(innerItem => {
              const innerFace = innerItem.querySelector('.voting-face');
              const innerCircle = innerFace.querySelector('.face-circle');
              const innerScore = parseInt(innerFace.getAttribute('data-score'), 10);
              innerCircle.setAttribute('fill', originalColors.get(innerScore));
            });
          });
          */
        });
      }
    });
  </script>

  {{ if eq .Lang "en" }}
  <div id="fb-root"></div>
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v20.0">
  </script>
  {{ end }}

  <script defer src="https://static.addtoany.com/menu/page.js"></script>

  {{ if eq .Lang "ru" }}
  <script src="https://vk.com/js/api/openapi.js?172" defer></script>
  <script>
    window.addEventListener('load', function () {
      VK.init({ apiId: 3245656, onlyWidgets: true });
      VK.Widgets.Comments("vk_comments", {
        limit: 10,
        attach: "*",
        pageUrl: "{{ .Permalink }}",
        width: "100%"
      });
    });
  </script>
  {{ end }}


</main>
{{ end }}