{{ define "main" }}
<main class="view pb posr bg-light">
  <img class="bg-light__img posa pointer db" src="/img/view-bg.svg" alt="" />
  <div class="container index">
    {{ partial "breadcrumbs.html" . }}

    <div class="card-list df jcsb">
      <div class="card-left">
        <div class="card-top df aic">
          <div class="card-star dif aic">
            <img src="/img/star.svg" alt="" class="img">
            <span>{{ .Params.rating }}</span>
          </div>
          <div class="card-top__item card-top__item-votes df aic">{{ T "total_votes" }} <span>{{ .Params.total_votes }}</span>
          </div>
          <div class="card-top__item df aic"><img src="/img/radio.svg" alt="">{{ T "catalog_created" }}: <span>{{ .Params.created
              }}</span></div>
        </div>
        <h1 class="card-title">{{ .Title }}</h1>
        <a href="{{ .Params.website_url }}" target="_blank"
          class="card-link hide link link-only-mob">{{ .Params.website_url }}</a>
        <img src="{{ .Params.logo }}" alt="{{ .Title }}" title="{{ .Title }}"
          class="img card-right__img card-right__img-mobile">

        <div class="card-mobile hide">
          <div class="card-right__item">
            <div class="card-right__item-title">{{ T "location" }}</div>
            <div class="card-right__item-flex df aic">
                <img src="/catalog/flags/{{ .Params.country_code }}.png" alt="{{ .Params.country_name }}"
                  title="{{ .Params.country_name }}" class="img"/> &nbsp;

                <span class="db"> {{ .Params.country_name }} {{ if .Params.region_name }}> {{ .Params.region_name }}{{
                  end }} {{ if .Params.city_name }}> {{ .Params.city_name }}{{ end }}
                </span>
            </div>
          </div>
          <div class="card-right__item">
            <div class="card-right__item-title">{{ T "language" }}</div>
            <div class="card-right__item-flex df aic">
              <!-- <img src="img/lang-2.svg" alt="" class="img"> -->
              <span class="db"> {{ range .Params.languages }}
                  <span>{{ . }}</span>
                  {{ end }}
              </span>

            </div>
          </div>
          <div class="card-right__item">
            <div class="card-right__item-title">{{ T "genres" }}</div>
            <div class="card-right__item-list df aic fxw">
              {{ range .Params.genres }}
                <div class="card-right__item-hash dif aic">#{{ . }}</div>
              {{ end }}
            </div>
          </div>
        </div>

        <div class="card-mob-list hide">
          <div class="card-top__item df aic"><img src="/img/radio.svg" alt="">{{ T "catalog_created" }}: <span>{{ .Params.created }}</span></div>
        </div>
        
        <a href="{{ .Params.website_url }}" target="_blank"
          class="card-link db link">{{ .Params.website_url }}</a>
        <div class="card-text">{{ .Params.description }}</div>

        <div class="card-flex">
          {{ if .Params.default_stream }}
          <audio id="stream-audio" class="stream-audio" preload="none">
            <source src="{{ .Params.default_stream }}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>

          <div class="card-player">
            <div class="player">
              <div class="player-btn"></div>
              <div class="player-select">
                <div class="select">
                  <select id="stream-select">
                    {{ range $i, $stream := .Params.streams }}
                    <option value="{{ $stream.stream_url }}" data-id="{{ $stream.id }}" {{ if eq $i 0 }}selected{{ end }}>{{ $stream.bitrate }}kbps {{ $stream.audio_format }}</option>
                    {{ end }}
                  </select>
                </div>
              </div>
              <div class="volume-wrapper">
                <div class="volume-icon"></div>
                <div class="volume-slider">
                  <div class="volume-fill" style="width: 70%;"><span></span></div>
                </div>
              </div>
              <div class="player-time">00:00</div>
            </div>
          </div>
          {{ end }}

          <div class="card-flex__right">
            <div class="card-flex__right-title">{{ T "links" }}</div>
            <div class="card-flex__right-list">
              <a id="link-m3u" href="/listen/stream_{{ (index .Params.streams 0).id }}.m3u" download class="card-flex__right-link">
                <img src="/img/link-1.svg" alt="" class="img">
                <span>m3u</span>
              </a>
              <a id="link-pls" href="/listen/stream_{{ (index .Params.streams 0).id }}.pls" download class="card-flex__right-link">
                <img src="/img/link-1.svg" alt="" class="img">
                <span>PLS</span>
              </a>
              <a id="link-web" href="{{ (index .Params.streams 0).stream_url }}" class="card-flex__right-link">
                <img src="/img/link-1.svg" alt="" class="img">
                <span>Web</span>
              </a>
            </div>
          </div>
        </div>

        <div class="card-save">
          <div class="card-soc__title"><img src="/img/radio.svg" alt=""><strong>{{ T "share_save_radio" }}</strong></div>
          <div class="card-save__list">
            {{ if eq .Lang "en" }}
            <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                <a class="a2a_button_email"></a>
                <a class="a2a_button_copy_link"></a>
                <a class="a2a_button_facebook"></a>
                <a class="a2a_button_telegram"></a>
                <a class="a2a_button_mastodon"></a>
                <a class="a2a_button_google_gmail"></a>
                <a class="a2a_button_snapchat"></a>
                <a class="a2a_button_twitter"></a>
                <a class="a2a_button_wechat"></a>
                <a class="a2a_button_whatsapp"></a>
                <a class="a2a_button_reddit"></a>
                <a class="a2a_button_linkedin"></a>
                <a class="a2a_button_x"></a>
                <a class="a2a_button_vk"></a>
                <a class="a2a_button_odnoklassniki"></a>
                <a class="a2a_button_viber"></a>
              </div>
            {{ end }}
            {{ if eq .Lang "ru" }}
            <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
              <a class="a2a_button_email"></a>
              <a class="a2a_button_copy_link"></a>
              <a class="a2a_button_telegram"></a>
              <a class="a2a_button_snapchat"></a>
              <a class="a2a_button_twitter"></a>
              <a class="a2a_button_wechat"></a>
              <a class="a2a_button_whatsapp"></a>
              <a class="a2a_button_reddit"></a>
              <a class="a2a_button_linkedin"></a>
              <a class="a2a_button_x"></a>
              <a class="a2a_button_vk"></a>
              <a class="a2a_button_odnoklassniki"></a>
            </div>
            {{ end }}
          </div>
        </div>

        <div class="card-soc" id="radio-voting-bar" 
             data-server-url="{{ $.Site.BaseURL }}" 
             data-radio-id="{{ $.Params.id }}"
             data-msg-success="{{ T "vote_success" }}"
             data-msg-already-voted="{{ T "vote_already_voted" }}"
             data-msg-forbidden="{{ T "vote_forbidden" }}"
             data-msg-error="{{ T "vote_error" }}"
             data-msg-network-error="{{ T "vote_network_error" }}">
          <div class="card-soc__wrapper">
            <div class="card-soc__title"><img src="/img/radio.svg" alt="">{{ T "rating_title" }} <span>{{ T "rate_radio" }}</span>
            </div>
            <div class="card-soc__scroll">
              <div class="card-soc__list">

                {{ range $i := seq 1 10 }}
                  <div class="card-soc__block voting-item" data-score="{{ $i }}">
                    <label class="card-soc__radio">
                      <input type="radio" name="rating">
                      <img src="/img/smile_{{ $i }}.svg" alt="" class="img">
                      <span>{{ $i }}</span>
                      <small></small>
                    </label>
                  </div>
                {{ end }}
              </div>
            </div>
          </div>
          <div id="vote-alert" class="index vote-alert" style="display: none;"></div>
          <div class="card-soc__bottom">
            <span>{{ T "final_rating" }} <strong>{{ .Params.rating }}</strong> {{ T "out_of" }}</span>
            <small>({{ .Params.total_votes }} {{ T "votes" }})</small>
          </div>
        </div>

        <div class="card-left__mobile">
          <a class="card-right__btn btn" href="{{ T "signup_url" }}"><img class="db" src="/img/marker.svg" alt=""><span
              class="db">{{ T "add_your_radio" }}</span></a>
        </div>


        <div class="card-box card-reviews">
          <div class="card-box__wrapper">
            
            {{ if eq .Lang "en" }}
            <!-- Facebook Comments Plugin -->
            <div class="index fb-comments" data-href="{{ .Permalink }}" data-width="100%" data-numposts="7"></div>
            {{ end }}

            {{ if eq .Lang "ru" }}
            <!-- VK comments container -->
            <div class="index comments-wrap"><div id="vk_comments"></div></div>
            {{ end }}
          </div>
        </div>
      </div>

      <div class="card-right">
        <div class="card-sticky">
          <div class="card-right__box">
            <img src="{{ .Params.logo }}" alt="{{ .Title }}" title="{{ .Title }}" class="img card-right__img">

            <div class="card-right__item">
              <div class="card-right__item-title">{{ T "location" }}</div>
              <div class="card-right__item-flex df aic">
                <img src="/catalog/flags/{{ .Params.country_code }}.png" alt="{{ .Params.country_name }}"
                  title="{{ .Params.country_name }}" class="img"/> &nbsp;

                <span class="db"> {{ .Params.country_name }} {{ if .Params.region_name }}> {{ .Params.region_name }}{{
                  end }} {{ if .Params.city_name }}> {{ .Params.city_name }}{{ end }}
                </span>
              </div>
            </div>
            <div class="card-right__item">
              <div class="card-right__item-title">{{ T "language" }}</div>
              <div class="card-right__item-flex df aic">
                <!--<img src="img/lang-2.svg" alt="" class="img">-->
                <span class="db"> {{ range .Params.languages }}
                  <span>{{ . }}</span>
                  {{ end }}
                </span>
              </div>
            </div>
            <div class="card-right__item">
              <div class="card-right__item-title">{{ T "genres" }}</div>
              <div class="card-right__item-list df aic fxw">
                {{ range .Params.genres }}
                <div class="card-right__item-hash dif aic">#{{ . }}</div>
                {{ end }}

              </div>
            </div>

          </div>
          <a class="card-right__btn btn" href="{{ T "signup_url" }}"><img class="db" src="/img/marker.svg" alt=""><span
              class="db">{{ T "add_your_radio" }}</span></a>
        </div>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Audio Player Logic
      const playPauseButtons = document.querySelectorAll('.play-pause-btn');
      const audioElements = document.querySelectorAll('.stream-audio');
      const volumeSlider = document.getElementById('volume-slider');

      // Volume slider (vanilla)
      const sliders = Array.from(document.querySelectorAll('.volume-slider'));
      let isDown = false;
      let activeSlider = null;
      let activeFill = null;
      let savedVolume = 0.7; // track volume before mute
      let isMuted = false;

      function setVolumeFor(slider, fill, e) {
        if (!slider || !fill) return;
        const rect = slider.getBoundingClientRect();
        const offset = e.pageX - (rect.left + window.pageXOffset);
        const width = rect.width || 1;
        let percent = (offset / width) * 100;
        percent = Math.max(0, Math.min(100, percent));
        fill.style.width = percent + '%';
        // apply volume to the audio player if present
        try {
          const audioEl = document.getElementById('stream-audio');
          if (audioEl) audioEl.volume = percent / 100;
        } catch (e) {
          // ignore in environments without DOM or audio
        }
      }

      sliders.forEach(slider => {
        const fill = slider.querySelector('.volume-fill');

        slider.addEventListener('mousedown', function (e) {
          isDown = true;
          activeSlider = slider;
          activeFill = fill;
          setVolumeFor(activeSlider, activeFill, e);
          // prevent text selection while dragging
          e.preventDefault();
        });

        slider.addEventListener('click', function (e) {
          setVolumeFor(slider, fill, e);
        });
      });

      document.addEventListener('mouseup', function () {
        isDown = false;
        activeSlider = null;
        activeFill = null;
      });

      document.addEventListener('mousemove', function (e) {
        if (isDown && activeSlider && activeFill) {
          setVolumeFor(activeSlider, activeFill, e);
        }
      });

      // Volume icon mute/unmute toggle
      const volumeIcon = document.querySelector('.volume-icon');
      
      if (volumeIcon) {
        volumeIcon.addEventListener('click', function (e) {
          e.stopPropagation(); // prevent event bubbling
          const audioEl = document.getElementById('stream-audio');
          if (!audioEl) return;
          
          if (isMuted) {
            // unmute: restore saved volume
            audioEl.volume = savedVolume;
            isMuted = false;
            volumeIcon.classList.remove('active');
            // restore visual slider
            const fill = document.querySelector('.volume-fill');
            if (fill) fill.style.width = (savedVolume * 100) + '%';
          } else {
            // mute: save current volume and set to 0
            savedVolume = audioEl.volume;
            audioEl.volume = 0;
            isMuted = true;
            volumeIcon.classList.add('active');
            // update visual slider
            const fill = document.querySelector('.volume-fill');
            if (fill) fill.style.width = '0%';
          }
        });
      }

      // Update links when stream select changes
      const streamSelect = document.getElementById('stream-select');
      const linkM3U = document.getElementById('link-m3u');
      const linkPLS = document.getElementById('link-pls');
      const linkWeb = document.getElementById('link-web');

      function updateStreamLinks() {
        if (!streamSelect) return;
        const selectedOption = streamSelect.options[streamSelect.selectedIndex];
        const streamId = selectedOption ? selectedOption.getAttribute('data-id') : null;
        const streamUrl = selectedOption ? selectedOption.value : null;

        if (streamId) {
          if (linkM3U) linkM3U.href = '/listen/stream_' + streamId + '.m3u';
          if (linkPLS) linkPLS.href = '/listen/stream_' + streamId + '.pls';
        }
        if (streamUrl && linkWeb) {
          linkWeb.href = streamUrl;
        }
      }

      if (streamSelect) {
        streamSelect.addEventListener('change', updateStreamLinks);
        // ensure links are in sync on load
        updateStreamLinks();
      }

      // Player controls (vanilla JS) â€” works only if <audio id="stream-audio"> exists
      const playerBtn = document.querySelector('.player-btn');
      const audioEl = document.getElementById('stream-audio');
      const playerTimeEl = document.querySelector('.player-time');
      let playerTimer = null;
      let elapsedSeconds = 0;

      function formatTime(sec) {
        const m = Math.floor(sec / 60).toString().padStart(2, '0');
        const s = Math.floor(sec % 60).toString().padStart(2, '0');
        return m + ':' + s;
      }

      if (audioEl && playerBtn) {
        // set initial volume from UI fill if present
        const initialFill = document.querySelector('.volume-fill');
        if (initialFill) {
          const pct = parseFloat(initialFill.style.width) || 70;
          audioEl.volume = pct / 100;
        }

        // toggle play/pause
        playerBtn.addEventListener('click', function () {
          if (audioEl.paused) {
            // start loading / playing
            playerBtn.classList.add('loading');
            audioEl.play().catch(err => {
              console.error('Playback failed:', err);
              playerBtn.classList.remove('loading');
            });
          } else {
            // stop playback
            audioEl.pause();
          }
        });

        // when playback actually starts
        audioEl.addEventListener('playing', function () {
          playerBtn.classList.remove('loading');
          playerBtn.classList.add('playing');
          playerBtn.classList.add('active');
          // start timer
          if (playerTimer) clearInterval(playerTimer);
          playerTimer = setInterval(function () {
            elapsedSeconds += 1;
            if (playerTimeEl) playerTimeEl.textContent = formatTime(elapsedSeconds);
          }, 1000);
        });

        // loading state
        audioEl.addEventListener('waiting', function () {
          playerBtn.classList.add('loading');
        });

        // pause/stop
        audioEl.addEventListener('pause', function () {
          playerBtn.classList.remove('playing');
          playerBtn.classList.remove('loading');
          playerBtn.classList.remove('active');
          if (playerTimer) { clearInterval(playerTimer); playerTimer = null; }
          elapsedSeconds = 0;
          if (playerTimeEl) playerTimeEl.textContent = '00:00';
        });

        // switch stream when select changes
        if (streamSelect) {
          streamSelect.addEventListener('change', function () {
            const newUrl = streamSelect.value;
            audioEl.src = newUrl;
            audioEl.load();
            // always start playing when a new stream is selected
            playerBtn.classList.add('loading');
            audioEl.play().catch(err => console.error('Playback failed after stream switch:', err));
          });
        }
      }

      // Voting Bar
      const votingBar = document.getElementById('radio-voting-bar');
      if (votingBar) {
        const votingItems = document.querySelectorAll('.voting-item');
        let hasVoted = false;
        const serverUrl = votingBar.getAttribute('data-server-url');
        const radioId = parseInt(votingBar.getAttribute('data-radio-id'));
        
        // Get translated messages
        const messages = {
          success: votingBar.getAttribute('data-msg-success'),
          alreadyVoted: votingBar.getAttribute('data-msg-already-voted'),
          forbidden: votingBar.getAttribute('data-msg-forbidden'),
          error: votingBar.getAttribute('data-msg-error'),
          networkError: votingBar.getAttribute('data-msg-network-error')
        };

        function showAlert(message, type) {
          const alert = document.getElementById('vote-alert');
          alert.textContent = message;
          alert.className = `index vote-alert ${type}`;
          alert.style.display = 'block';

          setTimeout(() => {
            alert.style.display = 'none';
          }, 5000);
        }

        function disableVoting() {
          hasVoted = true;
          votingItems.forEach(item => {
            item.classList.add('disabled');
          });
        }

        async function submitVote(radioId, score, serverUrl) {
          if(hasVoted){
            showAlert(messages.alreadyVoted, 'success');
            return;
          };
          try {
            const response = await fetch(`${serverUrl}api/v1/catalog/vote`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                radio_id: radioId,
                score: score
              })
            });

            if (response.ok) {
              showAlert(messages.success, 'success');
              disableVoting();
            } else if (response.status === 403) {
              showAlert(messages.forbidden, 'error');
              disableVoting();
            } else {
              showAlert(messages.error, 'error');
            }
          } catch (error) {
            showAlert(messages.networkError, 'error');
          }
        }

        votingItems.forEach(item => {
          const score = parseInt(item.getAttribute('data-score'), 10);

          // Click event for voting
          item.addEventListener('click', () => {
            submitVote(radioId, score, serverUrl);
          }, { once: true });
        });
      }
    });
  </script>

  {{ if eq .Lang "en" }}
  <div id="fb-root"></div>
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v20.0">
  </script>
  {{ end }}

  <script defer src="https://static.addtoany.com/menu/page.js"></script>

  {{ if eq .Lang "ru" }}
  <script src="https://vk.com/js/api/openapi.js?172" defer></script>
  <script>
    window.addEventListener('load', function () {
      VK.init({ apiId: 3245656, onlyWidgets: true });
      VK.Widgets.Comments("vk_comments", {
        limit: 10,
        attach: "*",
        pageUrl: "{{ .Permalink }}",
        width: "100%"
      });
    });
  </script>
  {{ end }}


</main>
{{ end }}